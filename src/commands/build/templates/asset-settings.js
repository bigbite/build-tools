const path = require('path');

const getFileName = (file, assetInfo, mode = 'develop') => {
  const parsedFile = path.parse(file);
  let name = parsedFile.name;

  const info = assetInfo?.get(file);
  const hash = info?.fullhash ?? info?.contenthash;

  if (mode === 'production' && hash) {
    name = name.replaceAll(hash, '');
  }

  // Remove trailing dash, change dashes to underscores, remove consecutive underscores.
  return name.replace(/-+$/, '').replaceAll(/-/g, '_').replaceAll(/_{2,}/g, '_').toUpperCase();
};

const getExtension = (file) => {
  const parsedFile = path.parse(file);
  return parsedFile.ext.split('.')[1].toUpperCase();
};

// eslint-disable-next-line arrow-body-style
const assetSettingsTemplate = (files, assetInfo, project, mode, version = 'v0.0.0') => {
  const setProject = project === '.' ? path.basename(path.resolve('./')) : project;
  const projectName = setProject.replace(/-/g, '_').toUpperCase();

  const fileDefinitions = (file) => {
    const parsedFile = path.parse(file);
    const name = getFileName(file, assetInfo, mode);
    const extension = getExtension(file);
    return `define( '${projectName}_${name}_${extension}', '${parsedFile.base}' );`;
  };

  const dependencyDefinitions = (file) => {
    if (!/(js|jsx)$/.test(file)) {
      return '';
    }

    const parsedFile = path.parse(file);
    const name = getFileName(file, assetInfo, mode);
    const { dependencies } = global.DependencyExtraction[project][parsedFile.name];
    return `define( '${projectName}_${name}_DEPENDENCIES', ${JSON.stringify(dependencies)} );`;
  };

  return `<?php
/**
 * phpcs:ignoreFile -- As this file is auto-generated, it should be excluded from linting.
 *
 * Asset settings generated by webpack.
 *
 * WARNING: Do not edit this file!
 * It will be created and updated automatically whenever new assets are created.
 */

${files.map(fileDefinitions).join(`\n`)}
${files.map(dependencyDefinitions).join(`\n`)}
define( '${project.replace(/-/g, '_').toUpperCase()}_VERSION', '${version}' );
`;
};

module.exports = assetSettingsTemplate;
